# 衍生品结构 Day004 触发逻辑说明文档（Trigger Engine）

本文件系统性描述该结构化衍生品在实盘运行中所依赖的触发机制、参数配置、触发逻辑链与路径选择方式。文档面向风险管理人员、技术开发者与衍生品交易结构审核者。

---

## 一、整体架构

该产品由两个主要触发环节组成：

* 敲入（Knock-In）：当套利收益率超过阈值 d=0.002 时启动套利路径执行逻辑
* 敲出（Knock-Out）：当套利收益率低于阈值 z=0.0005 时结束当前套利操作并重新匹配路径

整体触发系统依赖于以下要素：

1. **波动率监控模块（Volatility Monitor）**
2. **汇率路径生成器（Path Engine）**
3. **互换执行器（Swap Extension）**
4. **参数控制模块（Parameter Tuner）**

---

## 二、触发因子定义（Trigger Index）

### 1️⃣ 主触发指标：套利收益率

* 计算公式： $A(t) = \left(\prod S_{i \to i+1}(t) \right) \times (1 - \delta)^n - 1$
* 其中 $\delta$ 为每次交易手续费，默认值为 0.001

### 2️⃣ 附加触发因子（已实现）

* GARCH 模型波动率预测
* 国家干预阻力调节函数：$intervention = -0.01 \cdot \tanh(deviation \cdot 10)$

### 3️⃣ 未来扩展触发因子（待启用）

* 市场流动性指标（Bid-Ask Spread）
* 异常订单流信号（Order Flow Shock）
* 套利失败率历史回测（Backtest Rejection）

---

## 三、敲入逻辑（Knock-In Conditions）

敲入逻辑触发条件如下：

```
若存在一组货币路径（长度n），使得：
    多轮兑换后价值 > 1 + d
    且 全路径预计手续费 < d
则触发敲入。
```

> 当前实现：基本路径长度 n = 4，支持货币包括 USD, JPY, CNY, GBP, EUR

路径检测与筛选通过并行路径模拟完成，并筛除流动性不足币种。

---

## 四、敲出逻辑（Knock-Out Conditions）

触发条件：

```
若当前套利路径收益收缩，且：
    模拟后续路径获利期望 < z
则触发敲出，进入下轮路径匹配阶段。
```

另设缓冲窗口，避免微幅震荡引发频繁进出。

---

## 五、参数控制模块（Parameter Tuner）

### 可设参数：

| 参数符号 | 含义       | 默认值     | 说明           |
| ---- | -------- | ------- | ------------ |
| p    | 初始买入价格   | 视市场情况设定 | 视用户定价结果决定    |
| d    | 敲入偏离阈值   | 0.002   | 可被市场训练模块动态调整 |
| z    | 敲出预期收益阈值 | 0.0005  | 设置盈亏临界点      |
| n    | 货币路径长度   | 4       | 理论支持任意路径自动组合 |
| δ    | 每次交易手续费  | 0.001   | 影响总体套利收益    |

### 参数学习机制建议：

* 使用 3\~5 年外汇市场数据，训练适配不同时段的参数最优权重
* 引入生命周期概念，为每组参数配置设置有效期，如30日
* 可接入企业内部智能引擎，执行 rolling update 与反向传播调整

---

## 六、路径选择与扩展逻辑（Multi-Path）

* 当前支持的货币：USD, JPY, CNY, GBP, EUR
* 所有币种构成的可兑换路径被视为图结构中的有向图路径
* 在敲入阶段扫描所有长度 ≤ n 的回路，择优
* 当前已支持：4币种、5币种、6币种路径自由组合

---

## 七、波动率模型说明

本模型支持两种波动率模拟方式：

### 1️⃣ 静态波动率设置

* 货币对的基础波动率设置在 0.0060 ~ 0.0095 之间
* 不同货币对波动率各异，例如：
  * (USD, JPY): 0.0080
  * (USD, CNY): 0.0060
  * (CNY, GBP): 0.0095

### 2️⃣ GARCH 动态波动率

* 使用 GARCH(1,1) 模型模拟波动率的动态变化
* 通过 `simulate_garch_volatility` 函数生成时变波动率路径
* 可在 `simulate_rate_path_with_garch` 函数中使用

---

## 八、货币互换的介入点（Swap Extension）

货币互换在套利路径形成后用于延长套利时间：

* 用户本币 → 多币种兑换 → 执行互换 → 固定未来回币路径
* 利用互换合约将兑换价值锁定在未来某时点
* 避免套利机会在未完成兑付前失效

此结构为套利延时器模块（Delay Amplifier）的关键组成。

---

## 九、边界与异常处理机制

* 若市场进入高波动状态，触发保护性锁仓
* 若触发逻辑出现空路径或误检，进入 fail-safe 模式，恢复默认参数
* 实时记录路径失败原因并上传日志供回测分析

---

## 十、结语

本触发逻辑文档作为 Day004 结构的核心控制引擎描述，是连接模型执行与市场信号之间的桥梁。所有参数模块均可在部署时接入外部API或AI引擎进行动态优化。

结合 `pricing_model.py` 中的实际实现，可以完成真实市场环境下的模拟与回测验证。
